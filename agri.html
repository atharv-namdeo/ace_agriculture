<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Green Swarm — Fertilizer Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-deep: #050e0a;
            --bg-card: #0b1a12;
            --bg-panel: #0f2318;
            --green-neon: #00ff88;
            --green-mid: #00c96a;
            --green-dim: #005c30;
            --amber: #ffb300;
            --red-alert: #ff4444;
            --blue-gps: #4fc3f7;
            --purple: #b392f0;
            --text-main: #d4f5e0;
            --text-muted: #6a9f7e;
            --border: #1a3d26;
            --need-high: #ff4444;
            --need-med: #ffb300;
            --need-low: #00ff88;
            --done-color: #4fc3f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-deep);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ── NAV ── */
        nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            height: 58px;
            background: linear-gradient(90deg, #071410, #0b1f14);
            border-bottom: 1px solid var(--green-dim);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 18px;
            color: var(--green-neon);
            letter-spacing: 1px;
        }

        .nav-brand .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--green-neon);
            box-shadow: 0 0 10px var(--green-neon);
            animation: pulse 1.4s infinite;
        }

        .nav-links {
            display: flex;
            gap: 6px;
        }

        .nav-links a {
            padding: 6px 18px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all .2s;
            border: 1px solid transparent;
        }

        .nav-links a.active,
        .nav-links a:hover {
            background: #0f2318;
            color: var(--green-neon);
            border-color: var(--green-dim);
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        .pill {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            background: #0f2318;
            border: 1px solid var(--green-dim);
            font-size: 11px;
        }

        .pill-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .pill-dot.green {
            background: var(--green-neon);
            box-shadow: 0 0 6px var(--green-neon);
            animation: pulse 1.2s infinite;
        }

        .pill-dot.amber {
            background: var(--amber);
            box-shadow: 0 0 6px var(--amber);
        }

        /* ── TOOLBAR ── */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #070f0b;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 7px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
        }

        .tool-btn:hover {
            border-color: var(--green-dim);
            color: var(--text-main);
        }

        .tool-btn.active {
            background: #0f2318;
            border-color: var(--green-neon);
            color: var(--green-neon);
            box-shadow: 0 0 8px #00ff8822;
        }

        .tool-btn.danger {
            border-color: var(--red-alert);
            color: var(--red-alert);
        }

        .tool-btn.danger:hover {
            background: #2a0f0f;
        }

        .tool-btn.success {
            border-color: var(--green-neon);
            background: #00ff881a;
            color: var(--green-neon);
        }

        .tool-btn.success:hover {
            background: #00ff8830;
            box-shadow: 0 0 12px #00ff8833;
        }

        .tool-sep {
            width: 1px;
            height: 28px;
            background: var(--border);
        }

        .tool-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ── LEGEND PILLS ── */
        .need-legend {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .nl-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .nl-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        /* ── MAIN LAYOUT ── */
        .page-grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            height: calc(100vh - 116px);
            gap: 0;
        }

        /* ── MAP ── */
        #agriMap {
            width: 100%;
            height: 100%;
        }

        /* ── SIDE PANEL ── */
        .side-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all .2s;
            border-bottom: 2px solid transparent;
            letter-spacing: .3px;
        }

        .tab.active {
            color: var(--green-neon);
            border-bottom-color: var(--green-neon);
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Zones analysis tab */
        .zone-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zone-list::-webkit-scrollbar {
            width: 3px;
        }

        .zone-list::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .zone-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            border-left: 3px solid var(--green-dim);
            cursor: pointer;
            transition: all .2s;
        }

        .zone-card:hover {
            border-color: var(--green-neon);
            box-shadow: 0 0 12px #00ff8815;
        }

        .zone-card.selected {
            border-color: var(--green-neon);
            background: #0f2318;
        }

        .zone-card.fertilized {
            border-left-color: var(--done-color);
        }

        .zone-card.fertilized {
            opacity: .75;
        }

        .zone-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .zone-name {
            font-size: 13px;
            font-weight: 600;
        }

        .zone-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .badge-high {
            background: #ff44441a;
            border: 1px solid var(--red-alert);
            color: var(--red-alert);
        }

        .badge-med {
            background: #ffb3001a;
            border: 1px solid var(--amber);
            color: var(--amber);
        }

        .badge-low {
            background: #00ff881a;
            border: 1px solid var(--green-dim);
            color: var(--green-neon);
        }

        .badge-done {
            background: #4fc3f71a;
            border: 1px solid var(--blue-gps);
            color: var(--blue-gps);
        }

        .npk-row {
            display: flex;
            gap: 6px;
            margin: 6px 0;
        }

        .npk-chip {
            flex: 1;
            background: var(--bg-card);
            border-radius: 6px;
            padding: 5px 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .npk-label {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: .5px;
        }

        .npk-val {
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .npk-val.n {
            color: #ff8a65;
        }

        .npk-val.p {
            color: #81d4fa;
        }

        .npk-val.k {
            color: #ce93d8;
        }

        .zone-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .zone-check-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .zone-check {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .zone-check input[type=checkbox] {
            accent-color: var(--green-neon);
        }

        .zone-check label {
            font-size: 11px;
            cursor: pointer;
        }

        /* Rover transfer panel */
        .transfer-panel {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }

        .transfer-panel::-webkit-scrollbar {
            width: 3px;
        }

        .transfer-panel::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .rover-status-card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
        }

        .rover-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .rover-stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
        }

        .rover-stat .rl {
            font-size: 10px;
            color: var(--text-muted);
        }

        .rover-stat .rv {
            font-size: 15px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--blue-gps);
        }

        .rover-stat .rv.green {
            color: var(--green-neon);
        }

        .rover-stat .rv.amber {
            color: var(--amber);
        }

        .cmd-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
        }

        .cmd-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 10px;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }

        .mission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
        }

        .mission-item .mcoords {
            color: var(--text-muted);
        }

        .mission-item .mremove {
            cursor: pointer;
            color: var(--red-alert);
            border: none;
            background: transparent;
            font-size: 12px;
        }

        .big-btn {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all .3s;
            border: none;
            font-family: 'Inter', sans-serif;
            letter-spacing: .5px;
        }

        .big-btn.deploy {
            background: linear-gradient(135deg, #00c96a, #00ff88);
            color: #071410;
            box-shadow: 0 4px 20px #00ff8833;
        }

        .big-btn.deploy:hover {
            box-shadow: 0 6px 30px #00ff8855;
            transform: translateY(-1px);
        }

        .big-btn.deploy:active {
            transform: translateY(1px);
        }

        .big-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* History tab */
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-list::-webkit-scrollbar {
            width: 3px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .history-entry {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            border-left: 3px solid var(--done-color);
            animation: fadeIn .4s ease;
        }

        .hist-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .hist-zone {
            font-size: 13px;
            font-weight: 600;
            color: var(--blue-gps);
        }

        .hist-time {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .hist-details {
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hist-detail span {
            color: var(--text-main);
            font-weight: 500;
        }

        /* Stats strip at bottom */
        .stats-strip {
            display: flex;
            gap: 0;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
        }

        .stats-strip-item {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-right: 1px solid var(--border);
            font-size: 11px;
        }

        .stats-strip-item:last-child {
            border-right: none;
        }

        .stats-strip-item .sv {
            font-size: 20px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stats-strip-item .sl {
            color: var(--text-muted);
            font-size: 10px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            background: #0f2318;
            border: 1px solid var(--green-neon);
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 13px;
            color: var(--green-neon);
            box-shadow: 0 4px 20px #00ff8833;
            transform: translateY(80px);
            transition: transform .35s cubic-bezier(.34, 1.56, .64, 1);
            pointer-events: none;
        }

        .toast.show {
            transform: translateY(0);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--green-dim) transparent;
        }

        /* ── SCAN DATA TAB ── */
        .scan-panel {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .scan-panel::-webkit-scrollbar {
            width: 3px;
        }

        .scan-panel::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .scan-live-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
        }

        .scan-live-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .scan-live-title .live-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--green-neon);
            box-shadow: 0 0 6px var(--green-neon);
            animation: pulse 1s infinite;
        }

        .scan-readings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .scan-reading {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
        }

        .scan-reading .sr-label {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: .4px;
            text-transform: uppercase;
        }

        .scan-reading .sr-val {
            font-size: 16px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--green-neon);
        }

        .scan-reading .sr-unit {
            font-size: 9px;
            color: var(--text-muted);
        }

        .collect-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: 1px solid var(--green-dim);
            background: linear-gradient(135deg, #005c30, #00ff8833);
            color: var(--green-neon);
            font-family: 'Inter', sans-serif;
            transition: all .2s;
            letter-spacing: .3px;
        }

        .collect-btn:hover {
            box-shadow: 0 0 16px #00ff8840;
            border-color: var(--green-neon);
        }

        .collect-btn:active {
            transform: scale(.98);
        }

        .collect-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .scan-log-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .scan-log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .4px;
        }

        .scan-log-body {
            max-height: 220px;
            overflow-y: auto;
        }

        .scan-log-body::-webkit-scrollbar {
            width: 3px;
        }

        .scan-log-body::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .scan-entry {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 1fr 1fr;
            gap: 4px;
            padding: 6px 10px;
            border-bottom: 1px solid #0f2318;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            transition: background .15s;
            animation: fadeIn .3s ease;
        }

        .scan-entry:hover {
            background: #0f2318;
        }

        .scan-entry .se-time {
            color: var(--text-muted);
        }

        .scan-entry .se-coords {
            color: var(--blue-gps);
            grid-column: span 2;
        }

        .scan-entry-header {
            display: grid;
            grid-template-columns: 80px 1fr 1fr 1fr 1fr;
            gap: 4px;
            padding: 5px 10px;
            background: #0b1a12;
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: .4px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
        }

        /* ── SENSOR STRIP ── */
        .sensor-strip {
            display: flex;
            align-items: stretch;
            gap: 0;
            background: #070f0b;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .sensor-strip::-webkit-scrollbar {
            height: 3px;
        }

        .sensor-strip::-webkit-scrollbar-thumb {
            background: var(--green-dim);
        }

        .ss-group {
            display: flex;
            align-items: center;
            gap: 0;
            border-right: 1px solid var(--border);
            min-width: fit-content;
        }

        .ss-group-label {
            writing-mode: horizontal-tb;
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .8px;
            padding: 0 10px;
            border-right: 1px solid var(--border);
            height: 100%;
            display: flex;
            align-items: center;
            background: var(--bg-panel);
            white-space: nowrap;
        }

        .ss-sensor {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 6px 14px;
            border-right: 1px solid #0f2318;
            min-width: 90px;
            position: relative;
        }

        .ss-sensor:last-child {
            border-right: none;
        }

        .ss-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .4px;
        }

        .ss-val {
            font-size: 17px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.2;
        }

        .ss-unit {
            font-size: 9px;
            color: var(--text-muted);
        }

        .ss-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border);
        }

        .ss-bar-fill {
            height: 100%;
            border-radius: 1px;
            transition: width .7s ease;
        }

        .c-temp {
            color: #ff8a65;
        }

        .c-moist {
            color: #4fc3f7;
        }

        .c-n {
            color: #ff8a65;
        }

        .c-p {
            color: #81d4fa;
        }

        .c-k {
            color: #ce93d8;
        }

        .c-gas {
            color: #ffeb3b;
        }

        .c-ph {
            color: var(--amber);
        }

        .c-alarm {
            color: var(--red-alert);
            animation: pulse .8s infinite;
        }
    </style>
</head>

<body>

    <!-- NAV -->
    <nav>
        <div class="nav-brand">
            <div class="dot"></div>🌿 GREEN SWARM
        </div>
        <div class="nav-links">
            <a href="agri.html" class="active">🌱 Fertilizer Map</a>
        </div>
        <div class="nav-status">
            <div class="pill">
                <div class="pill-dot amber"></div>ROVER STANDBY
            </div>
            <div class="pill">
                <div class="pill-dot green"></div>ANALYSIS LIVE
            </div>
            <span id="clock" style="font-size:12px;color:var(--text-muted)"></span>
        </div>
    </nav>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <button class="tool-btn" onclick="toggleHeatmap()" id="btnHeat">🌡️ Heatmap</button>
        <button class="tool-btn" onclick="toggleFertDone()" id="btnDone">✅ Show Done</button>
        <div class="tool-sep"></div>
        <div class="need-legend">
            <div class="nl-item">
                <div class="nl-dot" style="background:var(--need-high)"></div>High Need
            </div>
            <div class="nl-item">
                <div class="nl-dot" style="background:var(--need-med)"></div>Medium
            </div>
            <div class="nl-item">
                <div class="nl-dot" style="background:var(--need-low)"></div>Low
            </div>
            <div class="nl-item">
                <div class="nl-dot" style="background:var(--done-color)"></div>Fertilized
            </div>
        </div>
        <div class="tool-sep"></div>
        <button class="tool-btn" id="btnSurv" onclick="toggleSurvDraw()" style="border-color:#fff700;color:#fff700">
            📡 Define Surveillance Area
        </button>
        <button class="tool-btn" id="btnStartSurv" onclick="launchSurveillance()"
            style="display:none;border-color:#00ff88;color:#00ff88">
            ▶ Start Surveillance
        </button>
        <button class="tool-btn" id="btnCancelSurv" onclick="cancelSurveillance()"
            style="display:none;border-color:#ff4444;color:#ff4444">
            ✖ Cancel Surveillance
        </button>
        <div class="tool-sep"></div>
        <button class="tool-btn" id="btnToggleFert" onclick="toggleFertilization()"
            style="border-color:#4fc3f7;color:#4fc3f7">
            ▶ Start Fertilization
        </button>
        <div style="margin-left:auto;font-size:11px;color:var(--text-muted)">📡 Zones auto-detected from drone scan
        </div>
    </div>

    <!-- SURVEILLANCE STATUS BAR -->
    <div id="survPanel" style="
        display:flex;align-items:center;gap:14px;
        padding:6px 18px;
        background:#07120a;
        border-bottom:1px solid #1a3d26;
        font-size:11px;font-family:Inter,sans-serif;
        flex-shrink:0;
    ">
        <span style="color:#6a9f7e;font-size:9px;letter-spacing:.6px;text-transform:uppercase">📡 Surveillance</span>
        <span id="survStatus" style="color:var(--text-muted);font-weight:700">⬜ IDLE — Draw an area on the map</span>
        <div style="flex:1;background:#0f2318;border-radius:4px;height:6px;overflow:hidden;max-width:260px">
            <div id="survBar"
                style="height:100%;width:0%;background:linear-gradient(90deg,#00ff88,#00c96a);border-radius:4px;transition:width .4s">
            </div>
        </div>
        <span id="survPct" style="color:var(--text-muted);min-width:32px">0%</span>
        <span id="survDrawHint" style="color:#fff700;font-size:10px;display:none">🖱️ Click &amp; drag on map to draw
            surveillance area</span>
    </div>

    <!-- LIVE SENSOR STRIP -->
    <div class="sensor-strip">

        <!-- Temperature -->
        <div class="ss-group">
            <div class="ss-group-label">🌡️ Temp</div>
            <div class="ss-sensor">
                <div class="ss-label">Air Temp</div>
                <div class="ss-val c-temp" id="ssAirTemp">--</div>
                <div class="ss-unit">°C</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssAirTempBar" style="background:#ff8a65;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">Soil Temp</div>
                <div class="ss-val c-temp" id="ssSoilTemp">--</div>
                <div class="ss-unit">°C</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssSoilTempBar" style="background:#ff7043;width:0%"></div>
                </div>
            </div>
        </div>

        <!-- Moisture -->
        <div class="ss-group">
            <div class="ss-group-label">💧 Moisture</div>
            <div class="ss-sensor">
                <div class="ss-label">Vol. Water</div>
                <div class="ss-val c-moist" id="ssMoistVol">--</div>
                <div class="ss-unit">%</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssMoistVolBar" style="background:#4fc3f7;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">Humidity</div>
                <div class="ss-val c-moist" id="ssHumidity">--</div>
                <div class="ss-unit">%</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssHumidityBar" style="background:#29b6f6;width:0%"></div>
                </div>
            </div>
        </div>

        <!-- NPK -->
        <div class="ss-group">
            <div class="ss-group-label">🌱 NPK</div>
            <div class="ss-sensor">
                <div class="ss-label">Nitrogen N</div>
                <div class="ss-val c-n" id="ssN">--</div>
                <div class="ss-unit">mg/kg</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssNBar" style="background:#ff8a65;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">Phosphorus P</div>
                <div class="ss-val c-p" id="ssP">--</div>
                <div class="ss-unit">mg/kg</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssPBar" style="background:#81d4fa;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">Potassium K</div>
                <div class="ss-val c-k" id="ssK">--</div>
                <div class="ss-unit">mg/kg</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssKBar" style="background:#ce93d8;width:0%"></div>
                </div>
            </div>
        </div>

        <!-- Gas Sensor -->
        <div class="ss-group">
            <div class="ss-group-label">☁️ Gas</div>
            <div class="ss-sensor">
                <div class="ss-label">CO₂</div>
                <div class="ss-val c-gas" id="ssCO2">--</div>
                <div class="ss-unit">ppm</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssCO2Bar" style="background:#ffeb3b;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">NH₃</div>
                <div class="ss-val c-gas" id="ssNH3">--</div>
                <div class="ss-unit">ppm</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssNH3Bar" style="background:#ffd600;width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">VOC</div>
                <div class="ss-val" id="ssVOC" style="color:#ffcc02">--</div>
                <div class="ss-unit">ppb</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssVOCBar" style="background:#ffcc02;width:0%"></div>
                </div>
            </div>
        </div>

        <!-- pH -->
        <div class="ss-group" style="border-right:none">
            <div class="ss-group-label">⚗️ pH / EC</div>
            <div class="ss-sensor">
                <div class="ss-label">pH Level</div>
                <div class="ss-val c-ph" id="ssPH">--</div>
                <div class="ss-unit">pH</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssPHBar" style="background:var(--amber);width:0%"></div>
                </div>
            </div>
            <div class="ss-sensor">
                <div class="ss-label">EC</div>
                <div class="ss-val c-ph" id="ssEC">--</div>
                <div class="ss-unit">dS/m</div>
                <div class="ss-bar">
                    <div class="ss-bar-fill" id="ssECBar" style="background:#ffa726;width:0%"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN -->
    <div class="page-grid" style="height:calc(100vh - 174px)">

        <!-- MAP -->
        <div style="position:relative">
            <div id="agriMap"></div>
        </div>

        <!-- SIDE PANEL -->
        <div class="side-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('zones',this)">🌾 Zones</div>
                <div class="tab" onclick="switchTab('rover',this)">🤖 Rover CMD</div>
                <div class="tab" onclick="switchTab('history',this)">📜 History</div>
                <div class="tab" onclick="switchTab('scan',this)">📡 Scan</div>
            </div>

            <!-- TAB: Zones -->
            <div class="tab-content active" id="tab-zones">
                <div class="zone-list" id="zoneList">
                    <p style="color:var(--text-muted);font-size:12px;text-align:center;margin-top:20px">
                        Click on the map to mark fertilizer need zones, or select a zone to inspect NPK values.
                    </p>
                </div>
                <div class="stats-strip">
                    <div class="stats-strip-item">
                        <div class="sv" id="statTotal" style="color:var(--text-main)">0</div>
                        <div class="sl">TOTAL ZONES</div>
                    </div>
                    <div class="stats-strip-item">
                        <div class="sv" id="statHigh" style="color:var(--red-alert)">0</div>
                        <div class="sl">HIGH NEED</div>
                    </div>
                    <div class="stats-strip-item">
                        <div class="sv" id="statDone" style="color:var(--blue-gps)">0</div>
                        <div class="sl">FERTILIZED</div>
                    </div>
                </div>
            </div>

            <!-- TAB: Rover CMD -->
            <div class="tab-content" id="tab-rover">
                <div class="transfer-panel">
                    <div class="rover-status-card">
                        <div
                            style="font-size:12px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">
                            🤖 Rover Status</div>
                        <div class="rover-stat-grid">
                            <div class="rover-stat">
                                <div class="rl">Battery</div>
                                <div class="rv amber" id="roverBatt">63%</div>
                            </div>
                            <div class="rover-stat">
                                <div class="rl">Status</div>
                                <div class="rv green" id="roverStatus">STANDBY</div>
                            </div>
                            <div class="rover-stat">
                                <div class="rl">Ammo (Bullets)</div>
                                <div class="rv" id="roverAmmo">142</div>
                            </div>
                            <div class="rover-stat">
                                <div class="rl">Speed</div>
                                <div class="rv green">1.2 m/s</div>
                            </div>
                        </div>
                    </div>

                    <div class="cmd-box">
                        <div class="cmd-title">📋 Mission Queue <span id="missionCount"
                                style="color:var(--green-neon)">(0 zones)</span></div>
                        <div class="mission-list" id="missionList">
                            <div style="color:var(--text-muted);font-size:11px;text-align:center;padding:10px">
                                No zones queued. Mark zones and add them to the mission.
                            </div>
                        </div>
                        <button class="big-btn deploy" id="deployBtn" onclick="deployRover()" disabled>
                            🚀 DEPLOY ROVER
                        </button>
                    </div>

                    <div class="cmd-box">
                        <div class="cmd-title">⚙️ Fertilizer Settings</div>
                        <div style="display:flex;flex-direction:column;gap:8px">
                            <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px">
                                <span style="color:var(--text-muted)">Bullets per zone:</span>
                                <input type="number" value="5" min="1" max="20" id="bulletsPerZone"
                                    style="width:60px;background:var(--bg-card);border:1px solid var(--border);color:var(--green-neon);border-radius:6px;padding:4px 8px;font-family:'JetBrains Mono',monospace;font-size:13px;text-align:center" />
                            </div>
                            <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px">
                                <span style="color:var(--text-muted)">Fertilizer type:</span>
                                <select id="fertType"
                                    style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-main);border-radius:6px;padding:4px 8px;font-size:12px">
                                    <option>NPK Composite</option>
                                    <option>Nitrogen-rich</option>
                                    <option>Phosphorus-rich</option>
                                    <option>Potassium-rich</option>
                                    <option>Organic</option>
                                </select>
                            </div>
                            <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px">
                                <span style="color:var(--text-muted)">Fire interval:</span>
                                <select id="fireInterval"
                                    style="background:var(--bg-card);border:1px solid var(--border);color:var(--text-main);border-radius:6px;padding:4px 8px;font-size:12px">
                                    <option>0.5s</option>
                                    <option>1s</option>
                                    <option>2s</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: History -->
            <div class="tab-content" id="tab-history">
                <div
                    style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border)">
                    <span style="font-size:12px;color:var(--text-muted)">Fertilization Records</span>
                    <button onclick="exportHistory()" class="tool-btn" style="padding:4px 10px;font-size:10px">⬇
                        Export</button>
                </div>
                <div class="history-list" id="historyList">
                    <p style="color:var(--text-muted);font-size:12px;text-align:center;margin-top:20px">
                        No fertilization records yet. Deploy the rover to start logging.
                    </p>
                </div>
                <div class="stats-strip">
                    <div class="stats-strip-item">
                        <div class="sv" id="histTotal" style="color:var(--blue-gps)">0</div>
                        <div class="sl">TOTAL RUNS</div>
                    </div>
                    <div class="stats-strip-item">
                        <div class="sv" id="histBullets" style="color:var(--purple)">0</div>
                        <div class="sl">BULLETS USED</div>
                    </div>
                    <div class="stats-strip-item">
                        <div class="sv" id="histArea" style="color:var(--green-neon)">0m²</div>
                        <div class="sl">AREA COVERED</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- TAB: Scan Data -->
        <div class="tab-content" id="tab-scan">
            <div class="scan-panel">

                <!-- Live Readings -->
                <div class="scan-live-box">
                    <div class="scan-live-title">
                        <div class="live-dot"></div>
                        Live Sensor Readings (Drone)
                    </div>
                    <div class="scan-readings">
                        <div class="scan-reading">
                            <div class="sr-label">Nitrogen (N)</div>
                            <div class="sr-val" id="sN">--</div>
                            <div class="sr-unit">mg/kg</div>
                        </div>
                        <div class="scan-reading">
                            <div class="sr-label">Phosphorus (P)</div>
                            <div class="sr-val" id="sP">--</div>
                            <div class="sr-unit">mg/kg</div>
                        </div>
                        <div class="scan-reading">
                            <div class="sr-label">Potassium (K)</div>
                            <div class="sr-val" id="sK">--</div>
                            <div class="sr-unit">mg/kg</div>
                        </div>
                        <div class="scan-reading">
                            <div class="sr-label">Moisture</div>
                            <div class="sr-val" id="sMoist" style="color:#4fc3f7">--</div>
                            <div class="sr-unit">%</div>
                        </div>
                        <div class="scan-reading">
                            <div class="sr-label">pH Level</div>
                            <div class="sr-val" id="sPH" style="color:var(--amber)">--</div>
                            <div class="sr-unit">pH</div>
                        </div>
                        <div class="scan-reading">
                            <div class="sr-label">EC</div>
                            <div class="sr-val" id="sEC" style="color:#ce93d8">--</div>
                            <div class="sr-unit">dS/m</div>
                        </div>
                    </div>
                    <div
                        style="margin-top:10px;font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace">
                        📍 Scanning at: <span id="scanPos" style="color:var(--green-neon)">--</span>
                    </div>
                </div>

                <!-- Collect Button -->
                <button class="collect-btn" id="collectBtn" onclick="collectData()">
                    📥 COLLECT DATA FOR THIS LOCATION
                </button>

                <!-- Scan Log Table -->
                <div class="scan-log-box">
                    <div class="scan-log-header">
                        <span>📊 Collected Field Data</span>
                        <div style="display:flex;gap:6px">
                            <span id="scanCount" style="color:var(--green-neon);font-size:10px">0 records</span>
                            <button onclick="clearScanLog()"
                                style="font-size:9px;padding:2px 7px;border-radius:4px;background:transparent;border:1px solid var(--border);color:var(--text-muted);cursor:pointer">CLEAR</button>
                            <button onclick="exportScanData()"
                                style="font-size:9px;padding:2px 7px;border-radius:4px;background:transparent;border:1px solid var(--green-dim);color:var(--green-neon);cursor:pointer">⬇
                                CSV</button>
                        </div>
                    </div>
                    <div class="scan-entry-header">
                        <span>TIME</span><span>N</span><span>P</span><span>K</span><span>pH</span>
                    </div>
                    <div class="scan-log-body" id="scanLogBody">
                        <div style="color:var(--text-muted);font-size:11px;text-align:center;padding:14px">
                            No data collected yet. Click Collect Data.
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script>
        // ── CLOCK ──
        function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
        setInterval(updateClock, 1000); updateClock();

        // ── MAP ──
        const map = L.map('agriMap', { zoomControl: true, attributionControl: false }).setView([20.5937, 78.9629], 2);

        // Free tile layers — no API key required
        const tileLayers = {
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri, Maxar, Earthstar Geographics', maxZoom: 20
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '©OpenStreetMap ©CartoDB', subdomains: 'abcd', maxZoom: 20
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '©OpenTopoMap ©OSM', subdomains: 'abc', maxZoom: 17
            })
        };
        // Satellite is default — best for field analysis
        tileLayers.satellite.addTo(map);
        let activeLayer = 'satellite';

        // Custom tile switcher
        const tileCtrl = L.control({ position: 'topright' });
        tileCtrl.onAdd = function () {
            const wrap = L.DomUtil.create('div', '');
            wrap.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
            const btns = [
                { key: 'satellite', label: '🛰️ Satellite' },
                { key: 'dark', label: '🌑 Dark' },
                { key: 'terrain', label: '🏔️ Terrain' }
            ];
            btns.forEach(b => {
                const btn = L.DomUtil.create('button', '', wrap);
                btn.textContent = b.label;
                btn.id = 'tileBtn_' + b.key;
                btn.style.cssText = `
                    background:${b.key === 'satellite' ? '#005c30' : 'rgba(5,14,10,.88)'};
                    color:${b.key === 'satellite' ? '#00ff88' : '#8ab99a'};
                    border:1px solid ${b.key === 'satellite' ? '#00ff88' : '#1a3d26'};
                    border-radius:7px;padding:5px 11px;font-size:11px;font-family:Inter,sans-serif;
                    cursor:pointer;white-space:nowrap;backdrop-filter:blur(8px);
                    font-weight:${b.key === 'satellite' ? '700' : '400'};
                    transition:all .15s;`;
                L.DomEvent.on(btn, 'click', function (e) {
                    L.DomEvent.stopPropagation(e);
                    map.removeLayer(tileLayers[activeLayer]);
                    tileLayers[b.key].addTo(map);
                    // Push tile layer to bottom so markers stay on top
                    tileLayers[b.key].bringToBack();
                    activeLayer = b.key;
                    btns.forEach(x => {
                        const el = document.getElementById('tileBtn_' + x.key);
                        const active = x.key === b.key;
                        el.style.background = active ? '#005c30' : 'rgba(5,14,10,.88)';
                        el.style.color = active ? '#00ff88' : '#8ab99a';
                        el.style.border = `1px solid ${active ? '#00ff88' : '#1a3d26'}`;
                        el.style.fontWeight = active ? '700' : '400';
                    });
                });
                L.DomEvent.disableClickPropagation(wrap);
            });
            return wrap;
        };
        tileCtrl.addTo(map);

        // ── ENTITY ICONS ──
        const blueRoverIcon = L.divIcon({
            html: `<div title="Blue Rover — Surveillance" style="
                width:26px;height:26px;border-radius:5px;
                background:#1565c0;border:2px solid #90caf9;
                box-shadow:0 0 14px #1976d2,0 0 4px #90caf9;
                display:flex;align-items:center;justify-content:center;
                font-size:13px;cursor:pointer;">🔵</div>`,
            className: '', iconAnchor: [13, 13]
        });
        const blackRoverIcon = L.divIcon({
            html: `<div title="Black Rover — Fertilizer" style="
                width:26px;height:26px;border-radius:5px;
                background:#1a1a1a;border:2px solid #616161;
                box-shadow:0 0 12px #424242;
                display:flex;align-items:center;justify-content:center;
                font-size:13px;cursor:pointer;">⚫</div>`,
            className: '', iconAnchor: [13, 13]
        });
        const droneIcon = L.divIcon({
            html: `<div title="Drone — Visual Surveillance" style="
                width:28px;height:28px;border-radius:50%;
                background:#00c96a;border:2px solid #00ff88;
                box-shadow:0 0 18px #00ff88,0 0 6px #00ff88;
                display:flex;align-items:center;justify-content:center;
                font-size:14px;cursor:pointer;animation:droneGlow 1.4s infinite alternate;">✈️</div>`,
            className: '', iconAnchor: [14, 14]
        });

        // ── GEOLOCATION — centre map at user's real location ──
        let originLat = 20.5937, originLng = 78.9629; // fallback

        // Starting positions (relative offsets from origin, filled after geo)
        let bRoverPos = [originLat - 0.0005, originLng - 0.0005];
        let blRoverPos = [originLat + 0.0007, originLng + 0.0009];
        let dronePos = [originLat, originLng];

        const blueRoverMarker = L.marker(bRoverPos, { icon: blueRoverIcon, zIndexOffset: 500 }).addTo(map)
            .bindTooltip('🔵 Scout Rover — Collecting sensor data', { permanent: false, direction: 'top', className: 'leaflet-tt' });
        const blackRoverMarker = L.marker(blRoverPos, { icon: blackRoverIcon, zIndexOffset: 500 }).addTo(map)
            .bindTooltip('⚫ Fertilizer Rover — Deploying bullets', { permanent: false, direction: 'top', className: 'leaflet-tt' });
        const droneMarker = L.marker(dronePos, { icon: droneIcon, zIndexOffset: 600 }).addTo(map)
            .bindTooltip('✈️ Surveillance Drone — Live feed active', { permanent: false, direction: 'top', className: 'leaflet-tt' });



        function initLocation(lat, lng) {
            originLat = lat; originLng = lng;
            map.setView([lat, lng], 17);

            // Reposition entities relative to real location
            bRoverPos = [lat - 0.0005, lng - 0.0005];
            blRoverPos = [lat + 0.0007, lng + 0.0009];
            dronePos = [lat + 0.0003, lng - 0.0003];
            blueRoverMarker.setLatLng(bRoverPos);
            blackRoverMarker.setLatLng(blRoverPos);
            droneMarker.setLatLng(dronePos);

            // Clear old trails
            bRoverTrail = []; blRoverTrail = []; droneTrail = [];
            bRoverLine.setLatLngs([]); blRoverLine.setLatLngs([]); droneLine.setLatLngs([]);

            showToast('�️ Map centred at field coordinates');
        }

        // Geolocation disabled — use default field coordinates
        // (called AFTER trail variables are declared below)

        // Trails
        let bRoverTrail = [];
        let blRoverTrail = [];
        let droneTrail = [];
        const bRoverLine = L.polyline([], { color: '#1976d2', weight: 2, opacity: .5, dashArray: '4 6' }).addTo(map);
        const blRoverLine = L.polyline([], { color: '#757575', weight: 2, opacity: .4, dashArray: '4 6' }).addTo(map);
        const droneLine = L.polyline([], { color: '#00ff88', weight: 1.5, opacity: .4, dashArray: '3 8' }).addTo(map);

        // Now safe to call — trails are declared
        initLocation(originLat, originLng);

        // Map legend overlay
        const legendCtrl = L.control({ position: 'bottomleft' });
        legendCtrl.onAdd = function () {
            const d = L.DomUtil.create('div', '');
            d.style.cssText = 'background:rgba(5,14,10,.88);backdrop-filter:blur(8px);border:1px solid #005c30;border-radius:10px;padding:10px 14px;font-size:11px;font-family:Inter,sans-serif;color:#d4f5e0;min-width:160px;';
            d.innerHTML = `
                <div style="font-size:9px;color:#6a9f7e;letter-spacing:.6px;margin-bottom:7px;text-transform:uppercase">Map Entities</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:12px;background:#1565c0;border-radius:3px;display:inline-block;box-shadow:0 0 6px #1976d2"></span>Scout Rover</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:12px;background:#1a1a1a;border:1.5px solid #616161;border-radius:3px;display:inline-block"></span>Fertilizer Rover</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:12px;background:#00ff88;border-radius:50%;display:inline-block;box-shadow:0 0 6px #00ff88"></span>Surveillance Drone</div>
                <hr style="border-color:#1a3d26;margin:6px 0"/>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:4px;background:#ff4444;border-radius:2px;display:inline-block"></span>High Need</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:4px;background:#ffb300;border-radius:2px;display:inline-block"></span>Medium</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:4px;background:#00ff88;border-radius:2px;display:inline-block"></span>Low Need</div>
                <div style="display:flex;align-items:center;gap:7px;margin:4px 0"><span style="width:12px;height:4px;background:#4fc3f7;border-radius:2px;display:inline-block"></span>Fertilized</div>`;
            L.DomEvent.disableClickPropagation(d);
            return d;
        };
        legendCtrl.addTo(map);

        // ══════════════════════════════════════════════════════════
        //  MOVEMENT ALGORITHMS
        // ══════════════════════════════════════════════════════════

        // ── 1. BLACK FERTILIZER ROVER — patrols between marked zones ──
        let fertActive = false;
        function toggleFertilization() {
            fertActive = !fertActive;
            const btn = document.getElementById('btnToggleFert');
            if (fertActive) {
                btn.innerHTML = '⏸ Pause Fertilization';
                showToast('🚜 Fertilization Started');
            } else {
                btn.innerHTML = '▶ Start Fertilization';
                showToast('🚜 Fertilization Paused');
            }
        }

        let fertTarget = null;   // current target zone index
        let fertDwell = 0;      // ticks dwelling at a zone

        function moveBlackRover() {
            // Build list of unfertilized zones
            const targets = zones.filter(z => !z.fertilized);

            if (targets.length === 0) {
                if (fertActive) {
                    toggleFertilization();
                    showToast('✅ All zones fertilized, rover returning to standby.');
                }
                const t = Date.now() / 9000;
                blRoverPos = [
                    originLat + Math.sin(t) * 0.00015,
                    originLng + Math.cos(t) * 0.00015
                ];
                blackRoverMarker.setLatLng(blRoverPos);
                blackRoverMarker.setTooltipContent('⚫ Fertilizer Rover — Standby (no zones)');
                return;
            }

            if (!fertActive) {
                blackRoverMarker.setTooltipContent('⚫ Fertilizer Rover — ⏸ Paused');
                return;
            }

            if (fertTarget === null || fertTarget >= targets.length) fertTarget = 0;

            const goal = targets[fertTarget];
            const cur = blRoverPos;
            const dlat = goal.lat - cur[0];
            const dlng = goal.lng - cur[1];
            const dist = Math.sqrt(dlat * dlat + dlng * dlng);

            if (dist < 0.00008) {
                fertDwell++;
                if (fertDwell > 5) {
                    fertDwell = 0;
                    markFertilized(goal.id);
                } else {
                    blackRoverMarker.setTooltipContent(`⚫ Fertilizer Rover — 🌿 Fertilizing zone...`);
                }
            } else {
                const speed = 0.00008;
                blRoverPos = [
                    cur[0] + (dlat / dist) * Math.min(dist, speed),
                    cur[1] + (dlng / dist) * Math.min(dist, speed)
                ];
                blackRoverMarker.setLatLng(blRoverPos);
                blackRoverMarker.setTooltipContent(`⚫ Fertilizer Rover — 🚗 En route to next zone`);
            }

            blRoverTrail.push([...blRoverPos]);
            if (blRoverTrail.length > 200) blRoverTrail.shift();
            blRoverLine.setLatLngs(blRoverTrail);
        }


        // ── 2. SURVEILLANCE MODE — coordinated drone + blue rover sweep ──
        let survZone = null;   // { minLat, maxLat, minLng, maxLng }
        let survActive = false;
        let survStrips = [];     // pre-computed waypoints
        let survDroneIdx = 0;
        let survRoverIdx = 0;
        let survDroneCompleted = false;
        let survRoverCompleted = false;
        let survRectLayer = null;
        let survProgress = 0;

        // Build lawnmower strips for an area, split in half for two agents
        function buildSurvStrips(bbox, numStrips) {
            const strips = [];
            const latStep = (bbox.maxLat - bbox.minLat) / numStrips;
            for (let i = 0; i <= numStrips; i++) {
                const lat = bbox.minLat + i * latStep;
                // Alternate left-right each row
                if (i % 2 === 0) strips.push([lat, bbox.minLng], [lat, bbox.maxLng]);
                else strips.push([lat, bbox.maxLng], [lat, bbox.minLng]);
            }
            return strips;
        }

        function startSurveillance(bbox) {
            survZone = bbox;
            survActive = true;
            const total = 18;

            const allStrips = buildSurvStrips(bbox, total);
            const half = Math.floor(allStrips.length / 2);
            survStrips = allStrips;
            survDroneIdx = 0;
            survRoverIdx = half;
            survDroneCompleted = false;
            survRoverCompleted = false;
            survProgress = 0;

            document.getElementById('survStatus').textContent = '🔴 SCANNING — Drone + Scout Rover active';
            document.getElementById('survStatus').style.color = '#ff4444';
            document.getElementById('survBar').style.width = '0%';
            showToast('📡 Surveillance started — Drone + Scout Rover sweeping area');
        }

        function stepSurveillance() {
            if (!survActive) return;

            const speed = 0.00008;

            // Drone moves through top half
            if (!survDroneCompleted && survDroneIdx < survStrips.length) {
                const goal = survStrips[survDroneIdx];
                const dlat = goal[0] - dronePos[0];
                const dlng = goal[1] - dronePos[1];
                const dist = Math.sqrt(dlat * dlat + dlng * dlng);
                if (dist < 0.00006) {
                    survDroneIdx++;
                    if (survDroneIdx >= Math.floor(survStrips.length / 2)) survDroneCompleted = true;
                } else {
                    dronePos = [dronePos[0] + (dlat / dist) * speed * 1.3, dronePos[1] + (dlng / dist) * speed * 1.3];
                }
                droneMarker.setLatLng(dronePos);
                droneTrail.push([...dronePos]);
                if (droneTrail.length > 200) droneTrail.shift();
                droneLine.setLatLngs(droneTrail);
            } else {
                survDroneCompleted = true;
            }

            // Blue rover moves through bottom half in reverse
            if (!survRoverCompleted && survRoverIdx < survStrips.length) {
                const goal = survStrips[survRoverIdx];
                const dlat = goal[0] - bRoverPos[0];
                const dlng = goal[1] - bRoverPos[1];
                const dist = Math.sqrt(dlat * dlat + dlng * dlng);
                if (dist < 0.00006) {
                    survRoverIdx++;
                    if (survRoverIdx >= survStrips.length) survRoverCompleted = true;
                } else {
                    bRoverPos = [bRoverPos[0] + (dlat / dist) * speed, bRoverPos[1] + (dlng / dist) * speed];
                }
                blueRoverMarker.setLatLng(bRoverPos);
                bRoverTrail.push([...bRoverPos]);
                if (bRoverTrail.length > 200) bRoverTrail.shift();
                bRoverLine.setLatLngs(bRoverTrail);
            } else {
                survRoverCompleted = true;
            }

            // Progress
            const done = (survDroneIdx + (survRoverIdx - Math.floor(survStrips.length / 2)));
            survProgress = Math.min(100, Math.round(done / survStrips.length * 100));
            document.getElementById('survBar').style.width = survProgress + '%';
            document.getElementById('survPct').textContent = survProgress + '%';

            function generateZonesFromSurveillance(bbox) {
                const spacing = 0.0003;
                let count = 0;
                for (let lat = bbox.minLat + spacing / 2; lat < bbox.maxLat; lat += spacing) {
                    for (let lng = bbox.minLng + spacing / 2; lng < bbox.maxLng; lng += spacing) {
                        const r = Math.random();
                        const level = r > 0.7 ? 'high' : (r > 0.4 ? 'med' : 'low');
                        createZone(lat, lng, level);
                        count++;
                    }
                }
                if (count > 0) showToast(`🌱 ${count} Zones auto-generated based on scan data!`);
            }

            if (survDroneCompleted && survRoverCompleted) {
                survActive = false;
                document.getElementById('survStatus').textContent = '✅ COMPLETE';
                document.getElementById('survStatus').style.color = '#00ff88';
                document.getElementById('survBar').style.width = '100%';
                document.getElementById('survPct').textContent = '100%';
                showToast('✅ Surveillance complete — Area fully scanned!');
                generateZonesFromSurveillance(survZone);
            }
        }

        // ── Default free-roam for blue rover + drone when no surveillance ──
        let entityTick = 0;
        function moveFreeRoam() {
            entityTick++;
            const t = entityTick * 0.018;
            const oL = originLat, oG = originLng;

            bRoverPos = [
                oL + Math.sin(t * 0.7) * 0.003 + Math.cos(t * 1.3) * 0.001,
                oG + Math.cos(t * 0.5) * 0.003 + Math.sin(t * 0.9) * 0.001
            ];
            blueRoverMarker.setLatLng(bRoverPos);
            bRoverTrail.push([...bRoverPos]);
            if (bRoverTrail.length > 120) bRoverTrail.shift();
            bRoverLine.setLatLngs(bRoverTrail);

            dronePos = [
                oL + Math.sin(t * 0.55 + 2.0) * 0.0045 + Math.sin(t * 1.8) * 0.0005,
                oG + Math.cos(t * 0.48 + 1.5) * 0.0048 + Math.cos(t * 1.6) * 0.0005
            ];
            droneMarker.setLatLng(dronePos);
            droneTrail.push([...dronePos]);
            if (droneTrail.length > 80) droneTrail.shift();
            droneLine.setLatLngs(droneTrail);
        }

        // Master tick
        function moveEntities() {
            moveBlackRover();
            if (survActive) stepSurveillance();
            else moveFreeRoam();
        }
        setInterval(moveEntities, 700);

        // State
        let currentTool = 'mark';
        let currentLevel = 'high';
        let zones = [];
        let heatmapVisible = false;
        let showDone = true;
        let heatmapCircles = [];
        let historyData = [];
        let totalBullets = 0;
        let totalArea = 0;

        // Colors
        const levelColor = { high: '#ff4444', med: '#ffb300', low: '#00ff88' };
        const levelLabel = { high: 'HIGH NEED', med: 'MEDIUM', low: 'LOW' };
        const levelBadge = { high: 'badge-high', med: 'badge-med', low: 'badge-low' };

        // ── MAP CLICK (disabled — zones are auto-detected from drone scan) ──
        // map.on('click', ...) removed

        function createZone(lat, lng, level) {
            const id = Date.now() + Math.floor(Math.random() * 1000);
            const t2 = Date.now() / 1000;
            // NPK
            const n = Math.round(10 + Math.random() * 80);
            const p = Math.round(10 + Math.random() * 80);
            const k = Math.round(10 + Math.random() * 80);
            // Temperature
            const airTemp = (28 + (Math.random() - 0.5) * 8).toFixed(1);
            const soilTemp = (22 + (Math.random() - 0.5) * 6).toFixed(1);
            // Moisture
            const moisture = Math.round(45 + Math.random() * 40);
            const humidity = Math.round(55 + Math.random() * 35);
            // Gas
            const co2 = Math.round(390 + Math.random() * 80);
            const nh3 = (0.6 + Math.random() * 2).toFixed(2);
            const voc = Math.round(120 + Math.random() * 200);
            // pH & EC
            const ph = (5.5 + Math.random() * 2.5).toFixed(1);
            const ec = (0.8 + Math.random() * 2.4).toFixed(2);

            const color = levelColor[level];
            const circle = L.circle([lat, lng], {
                radius: 18, color: color, fillColor: color, fillOpacity: 0.25, weight: 2
            }).addTo(map);

            const pulseMarker = L.circleMarker([lat, lng], {
                radius: 6, color: color, fillColor: color, fillOpacity: 1, weight: 2
            }).addTo(map);

            const zone = {
                id, lat, lng, level, n, p, k,
                airTemp, soilTemp, moisture, humidity,
                co2, nh3, voc, ph, ec, circle, pulseMarker, fertilized: false
            };
            zones.push(zone);

            // Clicking a marker always selects/highlights the zone in the sidebar
            const onZoneClick = function (e) {
                L.DomEvent.stopPropagation(e);
                selectZone(zone.id);
            };
            circle.on('click', onZoneClick);
            pulseMarker.on('click', onZoneClick);

            renderZoneList();
        }

        // ── ZONE LIST ──
        function renderZoneList() {
            const list = document.getElementById('zoneList');
            if (zones.length === 0) {
                list.innerHTML = '<p style="color:var(--text-muted);font-size:12px;text-align:center;margin-top:20px">No zones detected yet.</p>';
                updateStats(); return;
            }
            list.innerHTML = '';
            zones.slice().reverse().forEach(z => {
                const div = document.createElement('div');
                div.className = 'zone-card' + (z.fertilized ? ' fertilized' : '');
                div.id = 'zcard-' + z.id;

                const phColor = parseFloat(z.ph) < 5.5 ? '#ff4444' : parseFloat(z.ph) > 7.5 ? '#81d4fa' : '#ffb300';
                const co2Color = parseInt(z.co2) > 440 ? '#ff4444' : '#ffeb3b';

                div.innerHTML = `
                <div class="zone-row">
                    <div class="zone-name">📍 Zone @ ${z.lat.toFixed(4)}, ${z.lng.toFixed(4)}</div>
                    <span class="zone-badge ${z.fertilized ? 'badge-done' : levelBadge[z.level]}">${z.fertilized ? '✅ DONE' : levelLabel[z.level]}</span>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin:6px 0">

                  <!-- Temperature -->
                  <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:6px 8px">
                    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.4px">🌡️ TEMPERATURE</div>
                    <div style="font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#ff8a65">
                      Air: ${z.airTemp}°C &nbsp; Soil: ${z.soilTemp}°C
                    </div>
                  </div>

                  <!-- Moisture -->
                  <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:6px 8px">
                    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.4px">💧 MOISTURE</div>
                    <div style="font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;color:#4fc3f7">
                      Vol: ${z.moisture}% &nbsp; RH: ${z.humidity}%
                    </div>
                  </div>

                  <!-- Gas sensor -->
                  <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:6px 8px">
                    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.4px">☁️ GAS SENSOR</div>
                    <div style="font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace">
                      <span style="color:${co2Color}">CO₂ ${z.co2}ppm</span>
                      <span style="color:#ffd600"> NH₃ ${z.nh3}</span>
                      <span style="color:#ffcc02"> VOC ${z.voc}ppb</span>
                    </div>
                  </div>

                  <!-- pH / EC -->
                  <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:7px;padding:6px 8px">
                    <div style="font-size:9px;color:var(--text-muted);letter-spacing:.4px">⚗️ pH / EC</div>
                    <div style="font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace">
                      <span style="color:${phColor}">pH ${z.ph}</span>
                      <span style="color:#ffa726"> EC ${z.ec} dS/m</span>
                    </div>
                  </div>

                </div>

                <!-- NPK -->
                <div class="npk-row">
                  <div class="npk-chip"><div class="npk-label">NITROGEN</div><div class="npk-val n">${z.n}</div></div>
                  <div class="npk-chip"><div class="npk-label">PHOSPHORUS</div><div class="npk-val p">${z.p}</div></div>
                  <div class="npk-chip"><div class="npk-label">POTASSIUM</div><div class="npk-val k">${z.k}</div></div>
                </div>

                ${!z.fertilized
                        ? `<button onclick="event.stopPropagation();addToMission(${z.id})" class="tool-btn success" style="width:100%;margin-top:6px;justify-content:center">➕ Add to Rover Mission</button>`
                        : '<div style="font-size:11px;color:var(--blue-gps);text-align:center;margin-top:6px">✅ Fertilized — recorded</div>'
                    }
                `;
                div.onclick = () => selectZone(z.id);
                list.appendChild(div);
            });
            updateStats();
        }

        function selectZone(id) {
            const z = zones.find(x => x.id === id);
            if (!z) return;
            map.flyTo([z.lat, z.lng], 18, { duration: .6 });
            document.querySelectorAll('.zone-card').forEach(c => c.classList.remove('selected'));
            const card = document.getElementById('zcard-' + id);
            if (card) card.classList.add('selected');
        }

        function updateStats() {
            document.getElementById('statTotal').textContent = zones.length;
            document.getElementById('statHigh').textContent = zones.filter(z => z.level === 'high' && !z.fertilized).length;
            document.getElementById('statDone').textContent = zones.filter(z => z.fertilized).length;
        }

        // ── UNDO ──
        function undoLast() {
            const last = zones.pop();
            if (!last) return;
            map.removeLayer(last.circle);
            map.removeLayer(last.pulseMarker);
            renderZoneList();
            showToast('↩ Last zone removed');
        }

        // ── TOOL SELECTION ──
        function setTool(t) {
            currentTool = t;
            document.getElementById('btnMark').classList.toggle('active', t === 'mark');
            document.getElementById('btnView').classList.toggle('active', t === 'view');
            map.getContainer().style.cursor = t === 'mark' ? 'crosshair' : 'default';
        }

        function setNeedLevel(l) {
            currentLevel = l;
            ['High', 'Med', 'Low'].forEach(x => document.getElementById('lvl' + x).classList.remove('active'));
            document.getElementById('lvl' + l.charAt(0).toUpperCase() + l.slice(1)).classList.add('active');
        }

        // ── HEATMAP ──
        let heatLayers = [];
        function toggleHeatmap() {
            heatmapVisible = !heatmapVisible;
            document.getElementById('btnHeat').classList.toggle('active', heatmapVisible);
            heatLayers.forEach(l => map.removeLayer(l));
            heatLayers = [];
            if (heatmapVisible) {
                zones.filter(z => !z.fertilized).forEach(z => {
                    const r = z.level === 'high' ? 40 : z.level === 'med' ? 28 : 18;
                    const c = levelColor[z.level];
                    const l = L.circle([z.lat, z.lng], { radius: r, color: 'transparent', fillColor: c, fillOpacity: .18, weight: 0 }).addTo(map);
                    heatLayers.push(l);
                });
            }
        }

        // ── SHOW DONE TOGGLE ──
        function toggleFertDone() {
            showDone = !showDone;
            document.getElementById('btnDone').classList.toggle('active', showDone);
            zones.filter(z => z.fertilized).forEach(z => {
                if (showDone) { map.addLayer(z.circle); map.addLayer(z.pulseMarker); }
                else { map.removeLayer(z.circle); map.removeLayer(z.pulseMarker); }
            });
        }

        // ── MISSION QUEUE ──
        let mission = [];
        function addToMission(id) {
            const z = zones.find(x => x.id === id);
            if (!z || z.fertilized) return;
            if (mission.includes(id)) { showToast('⚠️ Zone already in queue'); return; }
            mission.push(id);
            renderMission();
            switchTab('rover', null);
            showToast('✅ Added to rover mission queue');
        }

        function removeFromMission(id) {
            mission = mission.filter(x => x !== id);
            renderMission();
        }

        function renderMission() {
            const list = document.getElementById('missionList');
            document.getElementById('missionCount').textContent = `(${mission.length} zones)`;
            document.getElementById('deployBtn').disabled = mission.length === 0;
            if (mission.length === 0) {
                list.innerHTML = '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:10px">No zones queued.</div>';
                return;
            }
            list.innerHTML = '';
            mission.forEach(id => {
                const z = zones.find(x => x.id === id);
                if (!z) return;
                const div = document.createElement('div');
                div.className = 'mission-item';
                div.innerHTML = `
      <span style="color:${levelColor[z.level]}">●</span>
      <span class="mcoords">${z.lat.toFixed(4)}, ${z.lng.toFixed(4)}</span>
      <span style="color:var(--text-muted)">${levelLabel[z.level]}</span>
      <button class="mremove" onclick="removeFromMission(${id})">✕</button>`;
                list.appendChild(div);
            });
        }

        // ── DEPLOY ──
        let deploying = false;
        function deployRover() {
            if (deploying || mission.length === 0) return;
            deploying = true;
            const btn = document.getElementById('deployBtn');
            btn.textContent = '⏳ DEPLOYING...';
            btn.disabled = true;
            document.getElementById('roverStatus').textContent = 'IN MISSION';
            document.getElementById('roverStatus').style.color = 'var(--green-neon)';
            showToast('🚀 Rover deployed! Processing mission...');

            let i = 0;
            const interval = setInterval(() => {
                if (i >= mission.length) {
                    clearInterval(interval);
                    deploying = false;
                    btn.textContent = '🚀 DEPLOY ROVER';
                    btn.disabled = false;
                    document.getElementById('roverStatus').textContent = 'STANDBY';
                    document.getElementById('roverStatus').style.color = 'var(--green-neon)';
                    mission = [];
                    renderMission();
                    showToast('✅ Mission complete! All zones fertilized.');
                    return;
                }
                const id = mission[i];
                markFertilized(id);
                i++;
            }, 1200);
        }

        function markFertilized(id) {
            const z = zones.find(x => x.id === id);
            if (!z) return;
            z.fertilized = true;

            // Update marker
            map.removeLayer(z.circle);
            map.removeLayer(z.pulseMarker);
            z.circle = L.circle([z.lat, z.lng], { radius: 18, color: '#4fc3f7', fillColor: '#4fc3f7', fillOpacity: .25, weight: 2 }).addTo(map);
            z.pulseMarker = L.circleMarker([z.lat, z.lng], { radius: 6, color: '#4fc3f7', fillColor: '#4fc3f7', fillOpacity: 1, weight: 2 }).addTo(map);

            const bullets = parseInt(document.getElementById('bulletsPerZone').value) || 5;
            const fertType = document.getElementById('fertType').value;
            const area = Math.round(Math.PI * 18 * 18);

            // Ammo update
            let ammo = parseInt(document.getElementById('roverAmmo').textContent);
            document.getElementById('roverAmmo').textContent = Math.max(0, ammo - bullets);

            // History
            const now = new Date();
            historyData.unshift({
                zone: `${z.lat.toFixed(4)}, ${z.lng.toFixed(4)}`,
                time: now.toLocaleString(),
                level: levelLabel[z.level],
                bullets, fertType, area,
                sensors: {
                    n: z.n, p: z.p, k: z.k,
                    airTemp: z.airTemp, soilTemp: z.soilTemp,
                    moist: z.moisture, humidity: z.humidity,
                    co2: z.co2, nh3: z.nh3, voc: z.voc,
                    ph: z.ph, ec: z.ec
                }
            });
            totalBullets += bullets;
            totalArea += area;

            renderHistory();
            renderZoneList();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (historyData.length === 0) {
                list.innerHTML = '<p style="color:var(--text-muted);font-size:12px;text-align:center;margin-top:20px">No records yet.</p>';
                return;
            }
            list.innerHTML = '';
            historyData.forEach(h => {
                const div = document.createElement('div');
                div.className = 'history-entry';
                div.innerHTML = `
      <div class="hist-top">
        <div class="hist-zone">📍 Zone @ ${h.zone}</div>
        <div class="hist-time">${h.time}</div>
      </div>
      <div class="hist-details">
        <div>Need: <span>${h.level}</span></div>
        <div>Bullets: <span>${h.bullets}</span></div>
        <div>Type: <span>${h.fertType}</span></div>
        <div>Area: <span>${h.area}m²</span></div>
      </div>
      <div style="margin-top:8px;padding-top:8px;border-top:1px dashed #1a3d26;display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:10px;font-family:'JetBrains Mono',monospace">
        <div style="color:var(--text-muted)">🌱 NPK: <span style="color:#ff8a65">${h.sensors.n}</span> <span style="color:#81d4fa">${h.sensors.p}</span> <span style="color:#ce93d8">${h.sensors.k}</span></div>
        <div style="color:var(--text-muted)">🌡️ Temp: <span style="color:#ff8a65">${h.sensors.airTemp}°C</span> <span style="color:#ff7043">${h.sensors.soilTemp}°C</span></div>
        <div style="color:var(--text-muted)">💧 Moist: <span style="color:#4fc3f7">${h.sensors.moist}%</span> RH: <span style="color:#29b6f6">${h.sensors.humidity}%</span></div>
        <div style="color:var(--text-muted)">⚗️ pH: <span style="color:var(--amber)">${h.sensors.ph}</span> EC: <span style="color:#ffa726">${h.sensors.ec}</span></div>
        <div style="color:var(--text-muted);grid-column:span 2">☁️ Gas: CO₂ <span style="color:#ffeb3b">${h.sensors.co2}</span> | NH3 <span style="color:#ffd600">${h.sensors.nh3}</span> | VOC <span style="color:#ffcc02">${h.sensors.voc}</span></div>
      </div>`;
                list.appendChild(div);
            });
            document.getElementById('histTotal').textContent = historyData.length;
            document.getElementById('histBullets').textContent = totalBullets;
            document.getElementById('histArea').textContent = totalArea + 'm²';
        }

        // ── EXPORT ──
        function exportHistory() {
            if (historyData.length === 0) { showToast('⚠️ No data to export'); return; }
            const jsonStr = JSON.stringify(historyData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'green_swarm_fertilization_log.json';
            a.click();
            showToast('📥 History exported as JSON!');
        }

        // ── TABS ──
        function switchTab(name, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            if (el) el.classList.add('active');
        }

        // ── TOAST ──
        var toastTimer;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => t.classList.remove('show'), 2800);
        }

        // ── SEED SOME DEMO ZONES ──
        setTimeout(() => {
            createZone(20.5941, 78.9635, 'high');
            createZone(20.5930, 78.9620, 'med');
            createZone(20.5945, 78.9615, 'high');
            createZone(20.5928, 78.9640, 'low');
            createZone(20.5952, 78.9625, 'med');
        }, 600);

        // Default cursor
        map.getContainer().style.cursor = 'crosshair';

        // ── SCAN DATA ──
        let scanData = [];
        let scanLive = { n: 0, p: 0, k: 0, moist: 0, ph: 0, ec: 0, lat: 20.5937, lng: 78.9629 };

        // Simulate live sensor readings from drone position
        function updateScanReadings() {
            const t = Date.now() / 1000;
            scanLive.n = Math.round(25 + Math.sin(t / 1.8) * 30 + Math.random() * 8);
            scanLive.p = Math.round(18 + Math.cos(t / 2.1) * 25 + Math.random() * 6);
            scanLive.k = Math.round(35 + Math.sin(t / 2.5) * 20 + Math.random() * 7);
            scanLive.moist = Math.round(55 + Math.sin(t / 3) * 18 + Math.random() * 4);
            scanLive.ph = (6.2 + Math.sin(t / 4) * 0.8 + Math.random() * 0.15).toFixed(1);
            scanLive.ec = (1.2 + Math.cos(t / 3.5) * 0.6 + Math.random() * 0.1).toFixed(2);
            // Simulate drone GPS drift
            scanLive.lat = 20.5937 + Math.sin(t / 6) * 0.0008 + (Math.random() - 0.5) * 0.00005;
            scanLive.lng = 78.9629 + Math.cos(t / 7) * 0.0008 + (Math.random() - 0.5) * 0.00005;

            document.getElementById('sN').textContent = scanLive.n;
            document.getElementById('sP').textContent = scanLive.p;
            document.getElementById('sK').textContent = scanLive.k;
            document.getElementById('sMoist').textContent = scanLive.moist;
            document.getElementById('sPH').textContent = scanLive.ph;
            document.getElementById('sEC').textContent = scanLive.ec;
            document.getElementById('scanPos').textContent =
                scanLive.lat.toFixed(5) + ', ' + scanLive.lng.toFixed(5);
        }
        setInterval(updateScanReadings, 900);
        updateScanReadings();

        function collectData() {
            const btn = document.getElementById('collectBtn');
            btn.disabled = true;
            btn.textContent = '⏳ Collecting...';
            setTimeout(() => {
                const record = {
                    time: new Date().toLocaleTimeString(),
                    lat: scanLive.lat.toFixed(5),
                    lng: scanLive.lng.toFixed(5),
                    n: scanLive.n,
                    p: scanLive.p,
                    k: scanLive.k,
                    moist: scanLive.moist,
                    ph: scanLive.ph,
                    ec: scanLive.ec
                };
                scanData.unshift(record);
                renderScanLog();
                showToast('📥 Data collected & stored!');
                btn.disabled = false;
                btn.textContent = '📥 COLLECT DATA FOR THIS LOCATION';
            }, 800);
        }

        function renderScanLog() {
            const body = document.getElementById('scanLogBody');
            document.getElementById('scanCount').textContent = scanData.length + ' records';
            if (scanData.length === 0) {
                body.innerHTML = '<div style="color:var(--text-muted);font-size:11px;text-align:center;padding:14px">No data collected yet.</div>';
                return;
            }
            body.innerHTML = '';
            scanData.forEach(r => {
                const div = document.createElement('div');
                div.className = 'scan-entry';
                div.innerHTML = `
                    <span class="se-time">${r.time}</span>
                    <span style="color:#ff8a65">${r.n}</span>
                    <span style="color:#81d4fa">${r.p}</span>
                    <span style="color:#ce93d8">${r.k}</span>
                    <span style="color:var(--amber)">${r.ph}</span>`;
                body.appendChild(div);
                // Add tooltip popup for full data on hover
                div.title = `📍 ${r.lat}, ${r.lng} | Moist: ${r.moist}% | EC: ${r.ec} dS/m`;
            });
        }

        function clearScanLog() {
            scanData = [];
            renderScanLog();
            showToast('🗑️ Scan log cleared');
        }

        function exportScanData() {
            if (scanData.length === 0) { showToast('⚠️ No data to export'); return; }
            const csv = ['Time,Lat,Lng,N(mg/kg),P(mg/kg),K(mg/kg),Moisture(%),pH,EC(dS/m)']
                .concat(scanData.map(r =>
                    `${r.time},${r.lat},${r.lng},${r.n},${r.p},${r.k},${r.moist},${r.ph},${r.ec}`))
                .join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'green_swarm_scan_data.csv';
            a.click();
            showToast('📥 Scan data exported!');
        }

        // ── SENSOR STRIP LIVE UPDATE ──
        function updateSensorStrip() {
            const t = Date.now() / 1000;

            // Temperature
            const airT = (28 + Math.sin(t / 5) * 4 + Math.random() * .4).toFixed(1);
            const soilT = (22 + Math.sin(t / 6) * 3 + Math.random() * .3).toFixed(1);
            document.getElementById('ssAirTemp').textContent = airT;
            document.getElementById('ssSoilTemp').textContent = soilT;
            document.getElementById('ssAirTempBar').style.width = Math.min(parseFloat(airT) / 50 * 100, 100) + '%';
            document.getElementById('ssSoilTempBar').style.width = Math.min(parseFloat(soilT) / 50 * 100, 100) + '%';

            // Moisture
            const moist = Math.round(58 + Math.sin(t / 4) * 14 + Math.random() * 3);
            const humid = Math.round(65 + Math.cos(t / 3.5) * 12 + Math.random() * 3);
            document.getElementById('ssMoistVol').textContent = moist;
            document.getElementById('ssHumidity').textContent = humid;
            document.getElementById('ssMoistVolBar').style.width = moist + '%';
            document.getElementById('ssHumidityBar').style.width = humid + '%';

            // NPK
            const nVal = Math.round(25 + Math.sin(t / 1.8) * 28 + Math.random() * 7);
            const pVal = Math.round(18 + Math.cos(t / 2.1) * 22 + Math.random() * 5);
            const kVal = Math.round(35 + Math.sin(t / 2.5) * 18 + Math.random() * 6);
            document.getElementById('ssN').textContent = nVal;
            document.getElementById('ssP').textContent = pVal;
            document.getElementById('ssK').textContent = kVal;
            document.getElementById('ssNBar').style.width = Math.min(nVal, 100) + '%';
            document.getElementById('ssPBar').style.width = Math.min(pVal, 100) + '%';
            document.getElementById('ssKBar').style.width = Math.min(kVal, 100) + '%';

            // Gas sensor
            const co2 = Math.round(400 + Math.sin(t / 7) * 30 + Math.random() * 8);
            const nh3 = (1.2 + Math.cos(t / 4) * 0.8 + Math.random() * 0.2).toFixed(2);
            const voc = Math.round(180 + Math.sin(t / 5) * 60 + Math.random() * 15);
            document.getElementById('ssCO2').textContent = co2;
            document.getElementById('ssNH3').textContent = nh3;
            document.getElementById('ssVOC').textContent = voc;
            document.getElementById('ssCO2Bar').style.width = Math.min(co2 / 1000 * 100, 100) + '%';
            document.getElementById('ssNH3Bar').style.width = Math.min(parseFloat(nh3) / 5 * 100, 100) + '%';
            document.getElementById('ssVOCBar').style.width = Math.min(voc / 500 * 100, 100) + '%';
            // Alarm colour if CO2 high
            const co2el = document.getElementById('ssCO2');
            co2el.className = 'ss-val ' + (co2 > 440 ? 'c-alarm' : 'c-gas');

            // pH + EC
            const ph = (6.2 + Math.sin(t / 4) * 0.9 + Math.random() * 0.1).toFixed(1);
            const ec = (1.3 + Math.cos(t / 3.5) * 0.5 + Math.random() * 0.08).toFixed(2);
            document.getElementById('ssPH').textContent = ph;
            document.getElementById('ssEC').textContent = ec;
            document.getElementById('ssPHBar').style.width = (parseFloat(ph) / 14 * 100).toFixed(1) + '%';
            document.getElementById('ssECBar').style.width = Math.min(parseFloat(ec) / 4 * 100, 100) + '%';
            // Colour pH by acidity range
            const phEl = document.getElementById('ssPH');
            phEl.style.color = parseFloat(ph) < 5.5 ? 'var(--red-alert)' : parseFloat(ph) > 7.5 ? '#81d4fa' : 'var(--amber)';
        }
        setInterval(updateSensorStrip, 1100);
        updateSensorStrip();

        // ── LIVE POSITION PANEL (Leaflet control, bottom-right) ──
        const posCtrl = L.control({ position: 'bottomright' });
        posCtrl.onAdd = function () {
            const d = L.DomUtil.create('div', '');
            d.id = 'posPanel';
            d.style.cssText = `
                background:rgba(5,14,10,.93);backdrop-filter:blur(10px);
                border:1px solid #005c30;border-radius:10px;
                padding:10px 13px;font-family:'JetBrains Mono',monospace;
                font-size:10px;color:#d4f5e0;min-width:210px;
                box-shadow:0 0 20px rgba(0,255,136,.08);`;
            d.innerHTML = `
                <div style="font-size:9px;color:#6a9f7e;letter-spacing:.6px;text-transform:uppercase;margin-bottom:8px;font-family:Inter,sans-serif">
                    📡 Real-Time Navigation
                </div>

                <div class="pos-row" style="display:grid;grid-template-columns:18px 1fr;align-items:start;gap:4px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #0f2318">
                    <span style="font-size:14px">🔵</span>
                    <div>
                        <div style="color:#90caf9;font-size:9px;font-family:Inter,sans-serif">SCOUT ROVER</div>
                        <div id="posBlue" style="color:#4fc3f7">--</div>
                        <div id="navBlue" style="color:#64b5f6;font-size:9px;font-family:Inter,sans-serif">Idle</div>
                    </div>
                </div>

                <div class="pos-row" style="display:grid;grid-template-columns:18px 1fr;align-items:start;gap:4px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #0f2318">
                    <span style="font-size:14px">⚫</span>
                    <div>
                        <div style="color:#9e9e9e;font-size:9px;font-family:Inter,sans-serif">FERTILIZER ROVER</div>
                        <div id="posBlack" style="color:#bdbdbd">--</div>
                        <div id="navBlack" style="color:#9e9e9e;font-size:9px;font-family:Inter,sans-serif">Standby</div>
                    </div>
                </div>

                <div class="pos-row" style="display:grid;grid-template-columns:18px 1fr;align-items:start;gap:4px">
                    <span style="font-size:14px">✈️</span>
                    <div>
                        <div style="color:#a5d6a7;font-size:9px;font-family:Inter,sans-serif">DRONE</div>
                        <div id="posDrone" style="color:#00ff88">--</div>
                        <div id="navDrone" style="color:#69f0ae;font-size:9px;font-family:Inter,sans-serif">Free sweep</div>
                    </div>
                </div>`;
            L.DomEvent.disableClickPropagation(d);
            L.DomEvent.disableScrollPropagation(d);
            return d;
        };
        posCtrl.addTo(map);

        function updatePosPanel() {
            // Heading helper — cardinal direction from dx/dy
            function heading(dlat, dlng) {
                if (Math.abs(dlat) < 0.000005 && Math.abs(dlng) < 0.000005) return '●';
                const deg = Math.round(Math.atan2(dlng, dlat) * 180 / Math.PI);
                const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW', 'N'];
                return dirs[Math.round((deg + 360) % 360 / 45)];
            }

            // Blue scout rover
            const bEl = document.getElementById('posBlue');
            const bNav = document.getElementById('navBlue');
            if (bEl) {
                bEl.textContent = `${bRoverPos[0].toFixed(5)}, ${bRoverPos[1].toFixed(5)}`;
                bNav.textContent = survActive
                    ? `⊹ Sweep ${heading(0, 0)} — Surveillance scan`
                    : `→ ${heading(bRoverPos[0] - originLat, bRoverPos[1] - originLng)} Free patrol`;
            }

            // Black fertilizer rover
            const blEl = document.getElementById('posBlack');
            const blNav = document.getElementById('navBlack');
            if (blEl) {
                blEl.textContent = `${blRoverPos[0].toFixed(5)}, ${blRoverPos[1].toFixed(5)}`;
                const targets = zones.filter(z => !z.fertilized);
                if (targets.length === 0) {
                    blNav.textContent = '● Standby — no zones';
                } else if (!fertActive) {
                    blNav.textContent = '⏸ Paused';
                } else {
                    const goal = targets[Math.min(fertTarget || 0, targets.length - 1)];
                    const dlat = goal.lat - blRoverPos[0];
                    const dlng = goal.lng - blRoverPos[1];
                    const dist = Math.sqrt(dlat * dlat + dlng * dlng);
                    const distM = Math.round(dist * 111320);
                    blNav.textContent = dist < 0.00008
                        ? `🌿 Fertilizing...`
                        : `→ ${heading(dlat, dlng)} Zone ${(fertTarget || 0) + 1} — ${distM}m`;
                }
            }

            // Drone
            const dEl = document.getElementById('posDrone');
            const dNav = document.getElementById('navDrone');
            if (dEl) {
                dEl.textContent = `${dronePos[0].toFixed(5)}, ${dronePos[1].toFixed(5)}`;
                dNav.textContent = survActive
                    ? `▣ Surveillance sweep ${survProgress}%`
                    : `↻ Free aerial sweep`;
            }
        }
        setInterval(updatePosPanel, 700);

        // ===================================================================
        //  SURVEILLANCE DRAW --- native DOM overlay (bypasses Leaflet events)
        // ===================================================================
        let survDrawMode = false;
        let survDrawStart = null;
        let survPendingBBox = null;

        const drawOverlay = document.createElement('div');
        drawOverlay.style.cssText = 'position:absolute;inset:0;z-index:800;display:none;cursor:crosshair;user-select:none;background:rgba(0,0,0,0.01);touch-action:none;';
        map.getContainer().style.position = 'relative';
        map.getContainer().appendChild(drawOverlay);

        const drawBox = document.createElement('div');
        drawBox.style.cssText = 'position:absolute;border:2px dashed #fff700;background:rgba(255,247,0,.08);pointer-events:none;display:none;box-shadow:0 0 8px rgba(255,247,0,.4);';
        drawOverlay.appendChild(drawBox);

        function _setDrawBox(x1, y1, x2, y2) {
            const l = Math.min(x1, x2), t = Math.min(y1, y2), w = Math.abs(x2 - x1), h = Math.abs(y2 - y1);
            drawBox.style.left = l + 'px'; drawBox.style.top = t + 'px';
            drawBox.style.width = w + 'px'; drawBox.style.height = h + 'px';
            drawBox.style.display = (w > 5 && h > 5) ? 'block' : 'none';
        }
        function _onDown(e) {
            e.preventDefault();
            const r = drawOverlay.getBoundingClientRect();
            survDrawStart = { x: e.clientX - r.left, y: e.clientY - r.top };
            drawBox.style.display = 'none';
        }
        function _onMove(e) {
            if (!survDrawStart) return;
            const r = drawOverlay.getBoundingClientRect();
            _setDrawBox(survDrawStart.x, survDrawStart.y, e.clientX - r.left, e.clientY - r.top);
        }
        function _onUp(e) {
            if (!survDrawStart) return;
            const r = drawOverlay.getBoundingClientRect();
            const ex = e.clientX - r.left, ey = e.clientY - r.top;
            const a = map.containerPointToLatLng(L.point(survDrawStart.x, survDrawStart.y));
            const b = map.containerPointToLatLng(L.point(ex, ey));
            exitDrawMode();
            const bbox = { minLat: Math.min(a.lat, b.lat), maxLat: Math.max(a.lat, b.lat), minLng: Math.min(a.lng, b.lng), maxLng: Math.max(a.lng, b.lng) };
            if (bbox.maxLat - bbox.minLat < 0.0002 || bbox.maxLng - bbox.minLng < 0.0002) {
                showToast('Too small - drag a larger area');
                document.getElementById('btnSurv').textContent = ' Define Surveillance Area';
                document.getElementById('btnSurv').style.background = '';
                document.getElementById('survStatus').textContent = ' IDLE - Draw an area on the map';
                document.getElementById('survStatus').style.color = 'var(--text-muted)';
                return;
            }
            if (survRectLayer) map.removeLayer(survRectLayer);
            survRectLayer = L.rectangle([[bbox.minLat, bbox.minLng], [bbox.maxLat, bbox.maxLng]],
                { color: '#fff700', weight: 2, fillColor: '#fff700', fillOpacity: .07, dashArray: '6 5' })
                .addTo(map).bindTooltip('Surveillance Area', { permanent: true, direction: 'top', className: 'leaflet-tt' });
            survPendingBBox = bbox;
            document.getElementById('btnSurv').textContent = ' Redefine Area';
            document.getElementById('btnSurv').style.background = '';
            document.getElementById('btnStartSurv').style.display = 'inline-flex';
            document.getElementById('btnCancelSurv').style.display = 'inline-flex';
            document.getElementById('survDrawHint').style.display = 'none';
            document.getElementById('survStatus').textContent = 'Area ready - press Start Surveillance';
            document.getElementById('survStatus').style.color = '#00ff88';
            showToast('Area defined - click Start Surveillance');
        }
        function enterDrawMode() {
            survDrawMode = true; survDrawStart = null; drawBox.style.display = 'none';
            map.dragging.disable(); map.scrollWheelZoom.disable();
            drawOverlay.style.display = 'block';
            drawOverlay.addEventListener('pointerdown', _onDown);
            drawOverlay.addEventListener('pointermove', _onMove);
            window.addEventListener('pointerup', _onUp);
        }
        function exitDrawMode() {
            survDrawMode = false; survDrawStart = null;
            drawOverlay.style.display = 'none'; drawBox.style.display = 'none';
            map.dragging.enable(); map.scrollWheelZoom.enable();
            drawOverlay.removeEventListener('pointerdown', _onDown);
            drawOverlay.removeEventListener('pointermove', _onMove);
            window.removeEventListener('pointerup', _onUp);
        }
        function toggleSurvDraw() {
            if (survDrawMode) {
                exitDrawMode();
                document.getElementById('btnSurv').textContent = ' Define Surveillance Area';
                document.getElementById('btnSurv').style.background = '';
                document.getElementById('survDrawHint').style.display = 'none';
                if (!survPendingBBox && !survActive) {
                    document.getElementById('survStatus').textContent = ' IDLE - Draw an area on the map';
                    document.getElementById('survStatus').style.color = 'var(--text-muted)';
                }
                return;
            }
            if (survActive) { showToast('Cancel current surveillance first'); return; }
            if (survRectLayer) { map.removeLayer(survRectLayer); survRectLayer = null; }
            survPendingBBox = null;
            document.getElementById('btnStartSurv').style.display = 'none';
            enterDrawMode();
            document.getElementById('btnSurv').style.background = 'rgba(255,247,0,.18)';
            document.getElementById('btnSurv').textContent = ' Cancel Draw';
            document.getElementById('survDrawHint').style.display = 'inline';
            document.getElementById('survStatus').textContent = 'DRAW MODE - click and drag on the map';
            document.getElementById('survStatus').style.color = '#fff700';
        }
        function launchSurveillance() {
            if (!survPendingBBox) { showToast('Define an area first'); return; }
            startSurveillance(survPendingBBox);
            survPendingBBox = null;
            document.getElementById('btnStartSurv').style.display = 'none';
        }
        function cancelSurveillance() {
            survActive = false; survPendingBBox = null;
            exitDrawMode();
            if (survRectLayer) { map.removeLayer(survRectLayer); survRectLayer = null; }
            document.getElementById('btnSurv').textContent = ' Define Surveillance Area';
            document.getElementById('btnSurv').style.background = '';
            document.getElementById('btnCancelSurv').style.display = 'none';
            document.getElementById('btnStartSurv').style.display = 'none';
            document.getElementById('survStatus').textContent = ' IDLE - Draw an area on the map';
            document.getElementById('survStatus').style.color = 'var(--text-muted)';
            document.getElementById('survBar').style.width = '0%';
            document.getElementById('survPct').textContent = '0%';
            document.getElementById('survDrawHint').style.display = 'none';
            showToast('Surveillance cancelled');
        }


    </script>
</body>

</html>